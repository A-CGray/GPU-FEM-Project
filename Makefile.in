# declare A2D location
A2D_DIR = ${HOME}/repos/a2d
A2D_INCLUDE = -I${A2D_DIR}/include

# declare TACS location
TACS_DIR = ${HOME}/repos/tacs
include ${TACS_DIR}/Makefile.in

TACS_LIB = ${TACS_DIR}/lib/libtacs.a

TACS_INCLUDE = -I${TACS_DIR}/src \
	-I${TACS_DIR}/src/bpmat \
	-I${TACS_DIR}/src/elements \
	-I${TACS_DIR}/src/elements/a2d \
	-I${TACS_DIR}/src/elements/dynamics \
	-I${TACS_DIR}/src/elements/basis \
	-I${TACS_DIR}/src/elements/shell \
	-I${TACS_DIR}/src/constitutive \
	-I${TACS_DIR}/src/functions \
	-I${TACS_DIR}/src/io

# GPU compile
GPU := true
GPU_CXX := nvcc
GPU_CC_FLAGS :=
MPI_INC =
MPI_LIB =
CUDA_LIBS :=

ifeq ($(GPU), true)
    # dynamically add MPI_INC and MPI_LIB from MPI compiler
    # since NVIDIA CUDA compiler not linked to MPI
    MPI_INC := $(shell ${CXX} -showme:incdirs | sed 's|[^ ]*|-I&|g')
    MPI_LIB := $(shell ${CXX} -showme:libdirs | sed 's|[^ ]*|-L&|g') -lmpi
    CUDA_LIBS := -L/usr/local/cuda/lib64 -lcudart

    CXX := $(GPU_CXX)
    # temporarily suppressing warnings with -w
    GPU_CC_FLAGS := -w -x cu -Xcompiler
    # optional sometimes need to downgrade gcc under the hood compiler
    # GPU_CC_FLAGS := --compiler-bindir=/usr/bin/gcc-10 -std=c++17 -x cu -Xcompiler
endif

# Set the command line flags to use for compilation
TACS_OPT_CC_FLAGS = ${TACS_DEF} ${EXTRA_CC_FLAGS} ${METIS_INCLUDE} ${AMD_INCLUDE} ${TECIO_INCLUDE} ${TACS_INCLUDE}
TACS_DEBUG_CC_FLAGS = ${TACS_DEF} ${EXTRA_DEBUG_CC_FLAGS} ${METIS_INCLUDE} ${AMD_INCLUDE} ${TECIO_INCLUDE} ${TACS_INCLUDE}

# By default, use the optimized flags
TACS_CC_FLAGS = ${TACS_OPT_CC_FLAGS}

# Set the linking flags to use
TACS_EXTERN_LIBS = ${AMD_LIBS} ${METIS_LIB} ${LAPACK_LIBS} ${TECIO_LIBS}
TACS_LD_FLAGS = ${EXTRA_LD_FLAGS} ${TACS_LD_CMD} ${TACS_EXTERN_LIBS}

# declare location of this directory for the GPU Macros
GPU_DIR = ${HOME}/repos/GPU-FEM-Project
GPU_MACRO_INCLUDE=-I${GPU_DIR}

include $(TACS_DIR)/Makefile.in
include $(TACS_DIR)/TACS_Common.mk
TACS_FLAGS = ${TACS_DEF} ${METIS_INCLUDE} ${AMD_INCLUDE} ${TECIO_INCLUDE} ${TACS_INCLUDE}

BENCHMARK_LINK=-lbenchmark
